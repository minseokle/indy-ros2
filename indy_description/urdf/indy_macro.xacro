<?xml version="1.0"?>
<robot xmlns:xacro="http://wiki.ros.org/xacro">

    <xacro:include filename="$(find indy_description)/urdf/indy.ros2_control.xacro" />
    <xacro:include filename="$(find indy_description)/urdf/indy_transmissions.xacro"/>
    <xacro:include filename="$(find indy_description)/urdf/indy_common.xacro"/>
    <xacro:include filename="$(find indy_description)/urdf/materials.xacro"/>

    <xacro:macro name="indy_robot" params="
        name
        indy_type
        indy_eye
        prefix
        parent
        *origin
        joint_limits_parameters_file
        kinematics_parameters_file
        physical_parameters_file
        visual_parameters_file
        transmission_hw_interface:=hardware_interface/PositionJointInterface
        sim_gazebo:=false">

        <!-- Load configuration data from the provided .yaml files -->
        <xacro:read_model_data
            joint_limits_parameters_file="${joint_limits_parameters_file}"
            kinematics_parameters_file="${kinematics_parameters_file}"
            physical_parameters_file="${physical_parameters_file}"
            visual_parameters_file="${visual_parameters_file}"
            indy_type="${indy_type}"/>

        <xacro:property name="indy_material" value="metal_white"/>

        <!-- links -  main serial chain -->
        <link name="${prefix}link0">
            <visual>
                <origin xyz="0 0 0" rpy="0 0 0"/>
                <geometry>
                    <xacro:get_mesh name="link0" type="visual"/>
                </geometry>
                <material name="${indy_material}"/>
            </visual>
            <collision>
                <origin xyz="0 0 0" rpy="0 0 0"/>
                <geometry>
                    <xacro:get_mesh name="link0" type="collision"/>
                </geometry>
            </collision>
            <xacro:indy_inertial mass="${link0_mass}" ixx="${inertia_link0_ixx}" iyy="${inertia_link0_iyy}" 
                izz="${inertia_link0_izz}" ixy="${inertia_link0_ixy}" iyz="${inertia_link0_iyz}" ixz="${inertia_link0_ixz}">
                <origin xyz="0 0 0" rpy="0 0 0" />
            </xacro:indy_inertial>
        </link>

        <link name="${prefix}link1">
            <visual>
                <origin xyz="0 0 0" rpy="0 0 0"/>
                <geometry>
                    <xacro:get_mesh name="link1" type="visual"/>
                </geometry>
                <material name="${indy_material}"/>
            </visual>
            <collision>
                <origin xyz="0 0 0" rpy="0 0 0"/>
                <geometry>
                    <xacro:get_mesh name="link1" type="collision"/>
                </geometry>
            </collision>
            <xacro:indy_inertial mass="${link1_mass}" ixx="${inertia_link1_ixx}" iyy="${inertia_link1_iyy}" 
                izz="${inertia_link1_izz}" ixy="${inertia_link1_ixy}" iyz="${inertia_link1_iyz}" ixz="${inertia_link1_ixz}">
                <origin xyz="0 0 0" rpy="0 0 0" />
            </xacro:indy_inertial>
        </link>

        <link name="${prefix}link2">
            <visual>
                <origin xyz="0 0 0" rpy="0 0 0"/>
                <geometry>
                    <xacro:get_mesh name="link2" type="visual"/>
                </geometry>
                <material name="${indy_material}"/>
            </visual>
            <collision>
                <origin xyz="0 0 0" rpy="0 0 0"/>
                <geometry>
                    <xacro:get_mesh name="link2" type="collision"/>
                </geometry>
            </collision>
            <xacro:indy_inertial mass="${link2_mass}" ixx="${inertia_link2_ixx}" iyy="${inertia_link2_iyy}" 
                izz="${inertia_link2_izz}" ixy="${inertia_link2_ixy}" iyz="${inertia_link2_iyz}" ixz="${inertia_link2_ixz}">
                <origin xyz="0 0 0" rpy="0 0 0" />
            </xacro:indy_inertial>
        </link>

        <link name="${prefix}link3">
            <visual>
                <origin xyz="0 0 0" rpy="0 0 0"/>
                <geometry>
                    <xacro:get_mesh name="link3" type="visual"/>
                </geometry>
                <material name="${indy_material}"/>
            </visual>
            <collision>
                <origin xyz="0 0 0" rpy="0 0 0"/>
                <geometry>
                    <xacro:get_mesh name="link3" type="collision"/>
                </geometry>
            </collision>
            <xacro:indy_inertial mass="${link3_mass}" ixx="${inertia_link3_ixx}" iyy="${inertia_link3_iyy}" 
                izz="${inertia_link3_izz}" ixy="${inertia_link3_ixy}" iyz="${inertia_link3_iyz}" ixz="${inertia_link3_ixz}">
                <origin xyz="0 0 0" rpy="0 0 0" />
            </xacro:indy_inertial>
        </link>

        <link name="${prefix}link4">
            <visual>
                <origin xyz="0 0 0" rpy="0 0 0"/>
                <geometry>
                    <xacro:get_mesh name="link4" type="visual"/>
                </geometry>
                <material name="${indy_material}"/>
            </visual>
            <collision>
                <origin xyz="0 0 0" rpy="0 0 0"/>
                <geometry>
                    <xacro:get_mesh name="link4" type="collision"/>
                </geometry>
            </collision>
            <xacro:indy_inertial mass="${link4_mass}" ixx="${inertia_link4_ixx}" iyy="${inertia_link4_iyy}" 
                izz="${inertia_link4_izz}" ixy="${inertia_link4_ixy}" iyz="${inertia_link4_iyz}" ixz="${inertia_link4_ixz}">
                <origin xyz="0 0 0" rpy="0 0 0" />
            </xacro:indy_inertial>
        </link>

        <link name="${prefix}link5">
            <visual>
                <origin xyz="0 0 0" rpy="0 0 0"/>
                <geometry>
                    <xacro:get_mesh name="link5" type="visual"/>
                </geometry>
                <material name="${indy_material}"/>
            </visual>
            <collision>
                <origin xyz="0 0 0" rpy="0 0 0"/>
                <geometry>
                    <xacro:get_mesh name="link5" type="collision"/>
                </geometry>
            </collision>
            <xacro:indy_inertial mass="${link5_mass}" ixx="${inertia_link5_ixx}" iyy="${inertia_link5_iyy}" 
                izz="${inertia_link5_izz}" ixy="${inertia_link5_ixy}" iyz="${inertia_link5_iyz}" ixz="${inertia_link5_ixz}">
                <origin xyz="0 0 0" rpy="0 0 0" />
            </xacro:indy_inertial>
        </link>

        <link name="${prefix}link6">

            <xacro:if value="${indy_eye and not (indy_type == 'indyrp2' or indy_type == 'indyrp2_v2')}">
                <visual>
                    <origin xyz="0 0 0" rpy="0 0 0"/>
                    <geometry>
                        <xacro:get_mesh name="link6_eye" type="visual"/>
                    </geometry>
                    <material name="${indy_material}"/>
                </visual>
                <collision>
                    <origin xyz="0 0 0" rpy="0 0 0"/>
                    <geometry>
                        <xacro:get_mesh name="link6_eye" type="collision"/>
                    </geometry>
                </collision>
            </xacro:if>

            <xacro:unless value="${indy_eye and not (indy_type == 'indyrp2' or indy_type == 'indyrp2_v2')}">
                <visual>
                    <origin xyz="0 0 0" rpy="0 0 0"/>
                    <geometry>
                        <xacro:get_mesh name="link6" type="visual"/>
                    </geometry>
                    <material name="${indy_material}"/>
                </visual>
                <collision>
                    <origin xyz="0 0 0" rpy="0 0 0"/>
                    <geometry>
                        <xacro:get_mesh name="link6" type="collision"/>
                    </geometry>
                </collision>
            </xacro:unless>

            <xacro:indy_inertial mass="${link6_mass}" ixx="${inertia_link6_ixx}" iyy="${inertia_link6_iyy}" 
                izz="${inertia_link6_izz}" ixy="${inertia_link6_ixy}" iyz="${inertia_link6_iyz}" ixz="${inertia_link6_ixz}">
                <origin xyz="0 0 0" rpy="0 0 0" />
            </xacro:indy_inertial>
        </link>

        <!--indyrp2 with 7 DOF-->
        <xacro:if value="${indy_type == 'indyrp2' or indy_type == 'indyrp2_v2'}">
            <link name="${prefix}link7">

                <xacro:if value="${indy_eye}">
                    <visual>
                        <origin xyz="0 0 0" rpy="0 0 0"/>
                        <geometry>
                            <xacro:get_mesh name="link7_eye" type="visual"/>
                        </geometry>
                        <material name="${indy_material}"/>
                    </visual>
                    <collision>
                        <origin xyz="0 0 0" rpy="0 0 0"/>
                        <geometry>
                            <xacro:get_mesh name="link7_eye" type="collision"/>
                        </geometry>
                    </collision>
                </xacro:if>

                <xacro:unless value="${indy_eye}">
                    <visual>
                        <origin xyz="0 0 0" rpy="0 0 0"/>
                        <geometry>
                            <xacro:get_mesh name="link7" type="visual"/>
                        </geometry>
                        <material name="${indy_material}"/>
                    </visual>
                    <collision>
                        <origin xyz="0 0 0" rpy="0 0 0"/>
                        <geometry>
                            <xacro:get_mesh name="link7" type="collision"/>
                        </geometry>
                    </collision>
                </xacro:unless>

                <xacro:indy_inertial mass="${link7_mass}" ixx="${inertia_link7_ixx}" iyy="${inertia_link7_iyy}" 
                    izz="${inertia_link7_izz}" ixy="${inertia_link7_ixy}" iyz="${inertia_link7_iyz}" ixz="${inertia_link7_ixz}">
                    <origin xyz="0 0 0" rpy="0 0 0" />
                </xacro:indy_inertial>
            </link>
        </xacro:if>

        <link name="${prefix}tcp"/>

        <joint name="global" type="fixed">
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <parent link="${parent}"/> <!--world-->
            <child link="$(arg prefix)link0"/>
        </joint>

        <joint name="${prefix}joint0" type="revolute">
            <parent link="${prefix}link0" />
            <child link="${prefix}link1" />
            <origin xyz="${joint0_x} ${joint0_y} ${joint0_z}" rpy="${joint0_roll} ${joint0_pitch} ${joint0_yaw}" />
            <axis xyz="0 0 1" />
            <limit lower="${joint0_lower_limit}" upper="${joint0_upper_limit}"
            effort="${joint0_effort_limit}" velocity="${joint0_velocity_limit}"/>
        </joint>

        <joint name="${prefix}joint1" type="revolute">
            <parent link="${prefix}link1" />
            <child link="${prefix}link2" />
            <origin xyz="${joint1_x} ${joint1_y} ${joint1_z}" rpy="${joint1_roll} ${joint1_pitch} ${joint1_yaw}" />
            <axis xyz="0 0 1" />
            <limit lower="${joint1_lower_limit}" upper="${joint1_upper_limit}"
            effort="${joint1_effort_limit}" velocity="${joint1_velocity_limit}"/>
        </joint>

        <joint name="${prefix}joint2" type="revolute">
            <parent link="${prefix}link2" />
            <child link="${prefix}link3" />
            <origin xyz="${joint2_x} ${joint2_y} ${joint2_z}" rpy="${joint2_roll} ${joint2_pitch} ${joint2_yaw}" />
            <axis xyz="0 0 1" />
            <limit lower="${joint2_lower_limit}" upper="${joint2_upper_limit}"
            effort="${joint2_effort_limit}" velocity="${joint2_velocity_limit}"/>
        </joint>

        <joint name="${prefix}joint3" type="revolute">
            <parent link="${prefix}link3" />
            <child link="${prefix}link4" />
            <origin xyz="${joint3_x} ${joint3_y} ${joint3_z}" rpy="${joint3_roll} ${joint3_pitch} ${joint3_yaw}" />
            <axis xyz="0 0 1" />
            <limit lower="${joint3_lower_limit}" upper="${joint3_upper_limit}"
            effort="${joint3_effort_limit}" velocity="${joint3_velocity_limit}"/>
        </joint>

        <joint name="${prefix}joint4" type="revolute">
            <parent link="${prefix}link4" />
            <child link="${prefix}link5" />
            <origin xyz="${joint4_x} ${joint4_y} ${joint4_z}" rpy="${joint4_roll} ${joint4_pitch} ${joint4_yaw}" />
            <axis xyz="0 0 1" />
            <limit lower="${joint4_lower_limit}" upper="${joint4_upper_limit}"
            effort="${joint4_effort_limit}" velocity="${joint4_velocity_limit}"/>
        </joint>

        <joint name="${prefix}joint5" type="revolute">
            <parent link="${prefix}link5" />
            <child link="${prefix}link6" />
            <origin xyz="${joint5_x} ${joint5_y} ${joint5_z}" rpy="${joint5_roll} ${joint5_pitch} ${joint5_yaw}" />
            <axis xyz="0 0 1" />
            <limit lower="${joint5_lower_limit}" upper="${joint5_upper_limit}"
            effort="${joint5_effort_limit}" velocity="${joint5_velocity_limit}"/>
        </joint>

        <!--indyrp2 with 7 DOF-->
        <xacro:if value="${indy_type == 'indyrp2' or indy_type == 'indyrp2_v2'}">
            <joint name="${prefix}joint6" type="revolute">
                <parent link="${prefix}link6" />
                <child link="${prefix}link7" />
                <origin xyz="${joint6_x} ${joint6_y} ${joint6_z}" rpy="${joint6_roll} ${joint6_pitch} ${joint6_yaw}" />
                <axis xyz="0 0 1" />
                <limit lower="${joint6_lower_limit}" upper="${joint6_upper_limit}"
                effort="${joint6_effort_limit}" velocity="${joint6_velocity_limit}"/>
            </joint>
            <joint name="${prefix}tcp" type="fixed">
                <parent link="${prefix}link7"/>
                <child link="${prefix}tcp"/>
                <origin xyz="0 0 0.06" rpy="0 0 0"/>
            </joint>
        </xacro:if>

        <xacro:unless value="${indy_type == 'indyrp2' or indy_type == 'indyrp2_v2'}">
            <joint name="${prefix}tcp" type="fixed">
                <parent link="${prefix}link6"/>
                <child link="${prefix}tcp"/>
                <origin xyz="0 0 0.06" rpy="0 0 0"/>
            </joint>
        </xacro:unless>

        <!-- ros2 control -->
        <xacro:indy_ros2_control
            name="${name}" 
            indy_type="${indy_type}"
            prefix="${prefix}"
            sim_gazebo="${sim_gazebo}"/>

        <!-- Add URDF transmission elements (for ros_control) -->
        <!-- <xacro:indy_transmission prefix="${prefix}" hw_interface="${transmission_hw_interface}" indy_type="${indy_type}"/> -->
    </xacro:macro>
</robot>
